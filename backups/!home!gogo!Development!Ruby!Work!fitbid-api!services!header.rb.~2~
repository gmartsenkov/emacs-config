require "wisper"

require_relative "../entities/header"
require_relative "../repositories/user"

module Fitbid
  module Services
    class Header
      include Wisper::Publisher

      def initialize(user_id:)
        @user_id = user_id
      end

      def call
        return not_found unless user
        broadcast "fitbid:header", header
      end

      private

      attr_reader :user_id

      def not_found
        broadcast "fitbid:user_not_found"
      end

      def user
        @_user ||= user_repo.by_id(user_id)
      end

      def user_repo
        Fitbid::Repositories::User.new(Fitbid::Database.env)
      end

      def header
        @_header ||= Fitbid::Header.new(header_attributes)
      end

      def header_attributes
        { name: user.name, email: user.email }
      end
    end
  end
end
